<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ls AiM - Link Shortener</title> 
  <meta name="theme-color" content="#22d3ee" />
  <meta name="description" content="Best Link Shortener Application powered by Firebase" /> 

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <style>
    body { 
        font-family: 'Poppins', 'Hind Siliguri', sans-serif; 
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        min-height: 100vh;
    }
    
    .glass-card { 
        background: rgba(30, 41, 59, 0.6); 
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px); 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        border-radius: 1.5rem; 
    }
    
    .input-field { 
        background-color: #1e293b; 
        border: 1px solid #334155; 
        border-radius: 0.75rem; 
        padding: 0.75rem 1rem; 
        color: white; 
        transition: all 0.3s ease; 
        width: 100%;
    }
    
    .input-field:focus-within {
        border-color: #22d3ee;
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
    }
    
    .btn-primary { 
        background: linear-gradient(90deg, #22d3ee, #06b6d4); 
        border-radius: 0.75rem; 
        padding: 0.8rem 1.5rem; 
        font-weight: 600; 
        color: #0f172a; 
        transition: all 0.3s ease; 
        box-shadow: 0 4px 20px rgba(34, 211, 238, 0.3); 
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .btn-primary:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 6px 25px rgba(34, 211, 238, 0.4);
    }

    .btn-secondary {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        color: #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: rgba(51, 65, 85, 0.8);
        border-color: #22d3ee;
        color: #22d3ee;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Result Box Animation */
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); height: 0; }
        to { opacity: 1; transform: translateY(0); height: auto; }
    }
    
    .slide-down {
        animation: slideDown 0.4s ease-out forwards;
    }
  </style>
</head>

<body class="min-h-screen">
  <header class="fixed top-0 left-0 right-0 z-40 bg-slate-900/80 backdrop-blur-lg border-b border-slate-700/50">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          
          <div class="w-10 h-10 rounded-xl object-cover border border-cyan-500/30 flex items-center justify-center bg-cyan-900/50">
             <img src="1000066307.jpg" 
                  onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'#22d3ee\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\'></path><path d=\'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\'></path></svg>\'" 
                  alt="ls AiM Logo" 
                  class="w-8 h-8 object-contain">
          </div>
          <div>
            <h1 class="text-xl font-bold text-white tracking-wide">ls AiM</h1>
            <p class="text-xs text-cyan-400">স্মার্ট লিঙ্ক সলিউশন</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
             <button id="logoutBtn" class="hidden md:flex text-sm text-slate-400 hover:text-white transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i> লগ আউট
             </button>
             <button id="mobileMenuBtn" class="md:hidden flex items-center gap-2 bg-slate-800/50 hover:bg-slate-700/50 px-3 py-2 rounded-lg transition-colors">
               <i class="fas fa-bars text-cyan-400"></i>
             </button>
        </div>
      </div>
    </div>
  </header>

  <div class="pt-24 pb-6 px-4">
    
    <main id="authPage" class="max-w-md mx-auto fade-in">
      <div class="text-center mb-8">
        <div class="relative w-24 h-24 mx-auto mb-4">
            <div class="absolute inset-0 bg-cyan-500 blur-xl opacity-20 rounded-full"></div>
            <div class="relative w-full h-full rounded-2xl object-cover border-2 border-slate-700 flex items-center justify-center bg-cyan-900/50">
                <img src="1000066307.jpg" 
                     onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'#22d3ee\' stroke-width=\'1.5\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\'></path><path d=\'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\'></path></svg>\'" 
                     alt="ls AiM Logo" 
                     class="w-16 h-16 object-contain">
            </div>
            </div>
        <h1 class="text-4xl font-bold text-white mb-2">ls AiM</h1>
        <p class="text-slate-400">আপনার লিঙ্ক ছোট করার সবচেয়ে সহজ মাধ্যম</p>
      </div>
      
      <section id="authSection">
        <div class="glass-card p-8 shadow-2xl shadow-cyan-900/10">
          <h2 id="authTitle" class="text-2xl font-bold text-white mb-6 text-center">স্বাগতম</h2>
          <form id="authForm" class="space-y-5">
            <div>
              <label for="authEmail" class="block text-sm font-medium text-slate-300 mb-2">ইমেইল অ্যাড্রেস</label>
              <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><i class="fas fa-envelope"></i></span>
                  <input type="email" id="authEmail" class="w-full input-field pl-10" placeholder="hello@example.com" required>
              </div>
            </div>
            
            <div>
              <label for="authPassword" class="block text-sm font-medium text-slate-300 mb-2">পাসওয়ার্ড</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><i class="fas fa-lock"></i></span>
                <input type="password" id="authPassword" class="w-full input-field pl-10 pr-10" placeholder="••••••••" required>
                <button type="button" class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-cyan-400 transition-colors">
                  <ion-icon name="eye-outline"></ion-icon>
                </button>
              </div>
            </div>
            
            <button type="submit" class="w-full btn-primary mt-4" id="authBtn">
              <span class="btn-text">লগ ইন করুন</span>
              <div class="btn-loading hidden flex items-center">
                <i class="fas fa-spinner fa-spin mr-2"></i> অপেক্ষা করুন...
              </div>
            </button>
          </form>
          
          <div class="mt-6 text-center">
            <p class="text-slate-400 text-sm">
              <span id="authToggleText">অ্যাকাউন্ট নেই?</span> 
              <button id="authToggleButton" class="text-cyan-400 hover:text-cyan-300 transition-colors font-medium ml-1">সাইন আপ করুন</button>
            </p>
          </div>
        </div>
      </section>
    </main>

    <main id="dashboardPage" class="hidden max-w-lg mx-auto fade-in">
      
      <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="glass-card p-4 flex flex-col items-center justify-center text-center">
             <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center mb-2 text-cyan-400">
                 <i class="fas fa-link"></i>
             </div>
             <div class="text-2xl font-bold text-white" id="totalLinksCount">0</div>
             <div class="text-xs text-slate-400">মোট লিঙ্ক</div>
          </div>
          <div class="glass-card p-4 flex flex-col items-center justify-center text-center">
            <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center mb-2 text-green-400">
                <i class="fas fa-mouse-pointer"></i>
            </div>
            <div class="text-2xl font-bold text-white" id="totalClicksCount">0</div>
            <div class="text-xs text-slate-400">মোট ক্লিক</div>
         </div>
      </div>

      <div class="glass-card p-6 mb-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 -mr-10 -mt-10 w-32 h-32 bg-cyan-500 blur-3xl opacity-10 rounded-full"></div>

        <h2 class="text-xl font-bold text-white mb-1">নতুন লিঙ্ক তৈরি করুন</h2>
        <p class="text-slate-400 text-sm mb-5">আপনার বড় লিঙ্কটি নিচে পেস্ট করুন</p>
        
        <form id="shortenForm" class="space-y-4 relative z-10">
            <div class="relative">
                <input type="url" id="longUrlInput" class="w-full input-field py-4 pl-4 pr-12 text-sm" placeholder="https://www.example.com/very-long-url..." required>
                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500">
                    <i class="fas fa-paste hover:text-cyan-400 cursor-pointer" onclick="navigator.clipboard.readText().then(t => document.getElementById('longUrlInput').value = t)"></i>
                </div>
            </div>
            
            <div class="relative">
                <label for="customAliasInput" class="block text-sm font-medium text-slate-300 mb-2 mt-2">
                    কাস্টম অ্যালিয়াস (ঐচ্ছিক)
                </label>
                <div class="flex items-center input-field p-0 focus-within:border-cyan-400">
                    <span class="text-slate-500 pl-3 text-sm flex-shrink-0" id="domainPrefix">
                        </span>
                    <input type="text" id="customAliasInput" class="bg-transparent text-sm w-full outline-none p-3 border-none" 
                           placeholder="যেমন: my-project-link">
                </div>
                <p id="aliasFeedback" class="text-xs mt-1 h-3 text-red-400"></p>
            </div>

            <button type="submit" class="w-full btn-primary shadow-lg shadow-cyan-500/20" id="shortenBtn">
                <span class="btn-text flex items-center"><i class="fas fa-magic mr-2"></i> লিঙ্ক ছোট করুন</span>
                <div class="btn-loading hidden flex items-center">
                    <i class="fas fa-spinner fa-spin mr-2"></i> প্রসেসিং...
                </div>
            </button>
        </form>

        <div id="resultBox" class="hidden mt-6 bg-slate-800/80 rounded-xl p-4 border border-green-500/30">
            <div class="flex flex-col space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-green-400 font-medium uppercase tracking-wider"><i class="fas fa-check-circle mr-1"></i> সফল হয়েছে</span>
                    <button class="text-slate-400 hover:text-white" onclick="document.getElementById('resultBox').classList.add('hidden')"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex items-center gap-2 bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                    <input type="text" id="shortUrlDisplay" class="bg-transparent text-cyan-400 font-mono text-sm w-full outline-none" readonly value="https://example.com/xyz123">
                    <button id="copyBtn" class="p-2 bg-cyan-500/10 hover:bg-cyan-500 hover:text-slate-900 text-cyan-400 rounded-md transition-all">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <button class="flex-1 btn-secondary text-xs flex justify-center items-center gap-2" onclick="window.open(document.getElementById('shortUrlDisplay').value, '_blank')">
                        <i class="fas fa-external-link-alt"></i> ভিজিট
                    </button>
                </div>
            </div>
        </div>
      </div>

      <div class="glass-card p-5">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">পূর্ববর্তী লিঙ্কসমূহ</h3>
            <button class="text-xs text-cyan-400 hover:text-white" id="clearHistoryBtn">সব মুছুন</button>
        </div>
        
        <div id="historyList" class="space-y-3">
            <div id="noHistoryMessage" class="text-center py-8 opacity-50">
                <i class="fas fa-history text-3xl mb-2 text-slate-600"></i>
                <p class="text-sm">কোনো ইতিহাস নেই</p>
            </div>
        </div>
      </div>

    </main>

    <div id="alertModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm px-4">
      <div class="bg-slate-800 rounded-2xl p-6 max-w-sm w-full glass-card border-slate-600 animate-[fadeIn_0.3s_ease-out]">
        <div class="text-center">
          <div id="alertIcon" class="fas fa-info-circle text-cyan-400 text-4xl mb-4"></div>
          <h3 id="alertTitle" class="text-xl font-bold text-white mb-2">Title</h3>
          <p id="alertMsg" class="text-slate-300 mb-6 text-sm">Message content.</p>
          <button class="w-full btn-primary" onclick="document.getElementById('alertModal').classList.add('hidden')">ঠিক আছে</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBVvFtACmQg_urhBOgoSVGYE0D4pfPQczs",
        authDomain: "aim-s-earning5.firebaseapp.com",
        databaseURL: "https://aim-s-earning5-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "aim-s-earning5",
        storageBucket: "aim-s-earning5.firebasestorage.app",
        messagingSenderId: "314717951853",
        appId: "1:314717951853:web:05fe777b43081fcf702c64",
        measurementId: "G-5QV5M8NYT0"
    };


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- DOM Elements ---
    const authPage = document.getElementById('authPage');
    const dashboardPage = document.getElementById('dashboardPage');
    const authForm = document.getElementById('authForm');
    const authEmailInput = document.getElementById('authEmail');
    const authPasswordInput = document.getElementById('authPassword');
    const authBtn = document.getElementById('authBtn');
    const authTitle = document.getElementById('authTitle');
    const authToggleText = document.getElementById('authToggleText');
    const authToggleButton = document.getElementById('authToggleButton');
    const logoutBtn = document.getElementById('logoutBtn');

    const shortenForm = document.getElementById('shortenForm');
    const longUrlInput = document.getElementById('longUrlInput');
    const customAliasInput = document.getElementById('customAliasInput');
    const aliasFeedback = document.getElementById('aliasFeedback');
    const domainPrefix = document.getElementById('domainPrefix');
    const shortenBtn = document.getElementById('shortenBtn');
    const resultBox = document.getElementById('resultBox');
    const shortUrlDisplay = document.getElementById('shortUrlDisplay');
    const copyBtn = document.getElementById('copyBtn');
    const historyList = document.getElementById('historyList');
    const totalLinksCount = document.getElementById('totalLinksCount');
    const totalClicksCount = document.getElementById('totalClicksCount');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const noHistoryMessage = document.getElementById('noHistoryMessage');

    let isLoginMode = true; // Default to login
    let currentUserUid = null;
    let unsubscribeFromLinks = null; // To manage real-time listener

    // --- Utility Functions ---

    function showLoader(btn) {
        btn.querySelector('.btn-text').classList.add('hidden');
        btn.querySelector('.btn-loading').classList.remove('hidden');
        btn.disabled = true;
    }

    function hideLoader(btn, originalText) {
        btn.querySelector('.btn-text').classList.remove('hidden');
        btn.querySelector('.btn-loading').classList.add('hidden');
        btn.querySelector('.btn-text').innerText = originalText; // Reset text
        btn.disabled = false;
    }

    function generateShortId(length = 6) {
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    function showAlert(title, msg, type = 'info') {
        const modal = document.getElementById('alertModal');
        const icon = document.getElementById('alertIcon');
        
        document.getElementById('alertTitle').innerText = title;
        document.getElementById('alertMsg').innerText = msg;
        
        if(type === 'success') icon.className = "fas fa-check-circle text-green-400 text-4xl mb-4";
        else if(type === 'error') icon.className = "fas fa-times-circle text-red-400 text-4xl mb-4";
        else icon.className = "fas fa-info-circle text-cyan-400 text-4xl mb-4";
        
        modal.classList.remove('hidden');
    }

    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.previousElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                this.querySelector('ion-icon').setAttribute('name', 'eye-off-outline');
            } else {
                input.type = 'password';
                this.querySelector('ion-icon').setAttribute('name', 'eye-outline');
            }
        });
    });

    function updateDomainPrefix() {
        // ডোমেইন নামটি প্রদর্শন করা
        domainPrefix.innerText = `${window.location.origin}/`;
    }

    // --- Authentication Logic ---

    authToggleButton.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        if (isLoginMode) {
            authTitle.innerText = 'স্বাগতম';
            authBtn.querySelector('.btn-text').innerText = 'লগ ইন করুন';
            authToggleText.innerText = 'অ্যাকাউন্ট নেই?';
            authToggleButton.innerText = 'সাইন আপ করুন';
        } else {
            authTitle.innerText = 'নতুন অ্যাকাউন্ট তৈরি করুন';
            authBtn.querySelector('.btn-text').innerText = 'সাইন আপ করুন';
            authToggleText.innerText = 'ইতিমধ্যে অ্যাকাউন্ট আছে?';
            authToggleButton.innerText = 'লগ ইন করুন';
        }
    });

    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = authEmailInput.value;
        const password = authPasswordInput.value;
        
        showLoader(authBtn);

        try {
            if (isLoginMode) {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener handles UI update
            } else {
                await auth.createUserWithEmailAndPassword(email, password);
                showAlert("সফল!", "অ্যাকাউন্ট তৈরি হয়েছে। এখন লগ ইন করুন।", "success");
                isLoginMode = true; // Switch to login mode after signup
                authToggleButton.click(); // Update UI
            }
        } catch (error) {
            console.error("Auth Error:", error.message);
            showAlert("ত্রুটি!", error.message, "error");
        } finally {
            hideLoader(authBtn, isLoginMode ? 'লগ ইন করুন' : 'সাইন আপ করুন');
        }
    });

    logoutBtn.addEventListener('click', async () => {
        try {
            await auth.signOut();
            showAlert("বিদায়!", "সফলভাবে লগ আউট হয়েছে।", "info");
        } catch (error) {
            console.error("Logout Error:", error.message);
            showAlert("ত্রুটি!", error.message, "error");
        }
    });

    // Firebase Auth State Listener
    auth.onAuthStateChanged(user => {
        if (user) {
            showDashboard(user.uid);
            logoutBtn.classList.remove('hidden');
            updateDomainPrefix();
        } else {
            authPage.classList.remove('hidden');
            dashboardPage.classList.add('hidden');
            authPage.classList.add('fade-in');
            logoutBtn.classList.add('hidden');
        }
    });

    // --- Dashboard & Link Shortening Logic ---

    async function showDashboard(uid) {
        currentUserUid = uid;
        authPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        dashboardPage.classList.add('fade-in');
        
        if (unsubscribeFromLinks) {
            unsubscribeFromLinks();
        }
        loadUserLinks(uid);
    }

    async function loadUserLinks(uid) {
        // রিয়েল-টাইম Firestore লিসেনার
        unsubscribeFromLinks = db.collection('users').doc(uid).collection('links')
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                const links = [];
                let totalClicks = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    links.push({ id: doc.id, ...data });
                    totalClicks += data.clicks || 0;
                });
                renderHistory(links);
                updateStats(links.length, totalClicks);
            }, error => {
                console.error("Error loading links:", error);
                showAlert("ত্রুটি!", "লিঙ্ক লোড করতে সমস্যা হয়েছে।", "error");
            });
    }

    shortenForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const longUrl = longUrlInput.value;
        let customAlias = customAliasInput.value.trim();
        aliasFeedback.innerText = ''; // Clear previous feedback

        showLoader(shortenBtn);

        try {
            // ১. কাস্টম অ্যালিয়াস চেক ও ভ্যালিডেশন
            let shortId;
            if (customAlias) {
                if (!/^[a-zA-Z0-9_-]{3,}$/.test(customAlias)) {
                    aliasFeedback.innerText = 'অ্যালিয়াসটি শুধুমাত্র অক্ষর, সংখ্যা, ড্যাশ বা আন্ডারস্কোর হতে পারে (সর্বনিম্ন ৩ অক্ষর)।';
                    hideLoader(shortenBtn, 'লিঙ্ক ছোট করুন');
                    return;
                }
                shortId = customAlias;
            } else {
                // স্বয়ংক্রিয় ID তৈরি
                shortId = generateShortId();
            }

            // ২. ডুপ্লিকেট চেক: প্রথমে ব্যবহারকারীর নিজস্ব লিঙ্ক চেক
            const existingLinkQuery = await db.collection('users').doc(currentUserUid)
                                    .collection('links').where('longUrl', '==', longUrl).get();

            if (!existingLinkQuery.empty) {
                const doc = existingLinkQuery.docs[0];
                const data = doc.data();
                const fullShortUrl = `${window.location.origin}/${doc.id}`;
                shortUrlDisplay.value = fullShortUrl;
                resultBox.classList.remove('hidden');
                resultBox.classList.add('slide-down');
                showAlert("ইতিমধ্যে বিদ্যমান!", "এই লিঙ্কটি আপনি আগেই ছোট করেছেন।", "info");
                return;
            }
            
            // ৩. ডুপ্লিকেট চেক: কাস্টম/অটো ID গ্লোবালি চেক
            let currentShortId = shortId;
            let isUnique = false;
            let attempt = 0;

            while(!isUnique && attempt < 10) { 
                 const doc = await db.collection('all_short_links').doc(currentShortId).get();
                 
                 if (!doc.exists) {
                    isUnique = true;
                 } else if (customAlias) {
                    // কাস্টম অ্যালিয়াস যদি আগে থেকেই থাকে তবে এরর দিয়ে লুপ থেকে বের হওয়া
                    aliasFeedback.innerText = 'এই কাস্টম অ্যালিয়াসটি ইতিমধ্যে ব্যবহৃত হয়েছে। অন্য একটি ব্যবহার করুন।';
                    hideLoader(shortenBtn, 'লিঙ্ক ছোট করুন');
                    return;
                 } else {
                    // অটো-জেনারেটেড ID ডুপ্লিকেট হলে নতুন ID তৈরি করা
                    currentShortId = generateShortId();
                 }
                 attempt++;
            }

            if (!isUnique) {
                showAlert("ত্রুটি!", "স্বয়ংক্রিয় ID তৈরি করতে সমস্যা হয়েছে। আবার চেষ্টা করুন।", "error");
                return;
            }

            shortId = currentShortId; // নিশ্চিত ইউনিক আইডি সেট করা হলো
            
            // ৪. Firebase এ সংরক্ষণ
            const fullShortUrl = `${window.location.origin}/${shortId}`;

            const newLink = {
                longUrl: longUrl,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                clicks: 0,
                userId: currentUserUid 
            };

            // গ্লোবাল এবং ইউজার কালেকশনে ডেটা সেভ করা (doc.id হিসেবে shortId ব্যবহার করা)
            await db.collection('users').doc(currentUserUid).collection('links').doc(shortId).set(newLink);
            await db.collection('all_short_links').doc(shortId).set(newLink);


            shortUrlDisplay.value = fullShortUrl;
            resultBox.classList.remove('hidden');
            resultBox.classList.add('slide-down');
            customAliasInput.value = ""; // Clear alias input
            longUrlInput.value = ""; // Clear long URL input
            showAlert("সফল!", `আপনার লিঙ্ক সফলভাবে ছোট করা হয়েছে: ${shortId}`, "success");

        } catch (error) {
            console.error("Shorten Error:", error);
            showAlert("ত্রুটি!", "লিঙ্ক ছোট করতে সমস্যা হয়েছে: " + error.message, "error");
        } finally {
            hideLoader(shortenBtn, 'লিঙ্ক ছোট করুন');
        }
    });

    // --- Copy Logic ---
    copyBtn.addEventListener('click', function() {
        shortUrlDisplay.select();
        document.execCommand('copy');
        
        const originalHtml = this.innerHTML;
        this.innerHTML = '<i class="fas fa-check"></i>';
        this.classList.add('bg-green-500', 'text-slate-900');
        
        setTimeout(() => {
            this.innerHTML = originalHtml;
            this.classList.remove('bg-green-500', 'text-slate-900');
        }, 2000);
    });

    // --- History & Stats Rendering ---
    function updateStats(numLinks, numClicks) {
        totalLinksCount.innerText = numLinks;
        totalClicksCount.innerText = numClicks;
    }

    function renderHistory(links) {
        historyList.innerHTML = ''; // Clear existing history
        if (links.length === 0) {
            noHistoryMessage.classList.remove('hidden');
            return;
        }
        noHistoryMessage.classList.add('hidden');

        links.forEach(link => {
            const date = link.createdAt ? new Date(link.createdAt.seconds * 1000).toLocaleDateString('bn-BD') : 'এখনই';
            const fullShortLink = `${window.location.origin}/${link.id}`;

            const linkHtml = `
            <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 hover:border-cyan-500/30 transition-colors group">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-slate-700 flex items-center justify-center text-cyan-400">
                            <i class="fas fa-link text-xs"></i>
                        </div>
                        <div>
                            <h4 class="text-white font-medium text-sm truncate max-w-[150px]">${link.id} (${link.clicks} ক্লিক)</h4>
                            <p class="text-slate-500 text-[10px]">${date}</p>
                        </div>
                    </div>
                    <button onclick="copyText('${fullShortLink}', this)" class="text-slate-400 hover:text-cyan-400 transition-colors">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <div class="bg-slate-900/50 rounded p-2 text-[10px] text-slate-400 truncate border-l-2 border-slate-600">
                    ${link.longUrl}
                </div>
            </div>
            `;
            historyList.insertAdjacentHTML('beforeend', linkHtml);
        });
    }

    // Global copy function for history items
    window.copyText = (text, btn) => {
        const temp = document.createElement('input');
        document.body.appendChild(temp);
        temp.value = text;
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        
        const icon = btn.querySelector('i');
        icon.className = 'fas fa-check text-green-400';
        setTimeout(() => icon.className = 'far fa-copy', 1500);
    };

    // Clear History (Clears only user's links, global links remain for redirection)
    clearHistoryBtn.addEventListener('click', async () => {
        if(confirm('আপনি কি সব ইতিহাস মুছে ফেলতে চান? এটি শুধুমাত্র ড্যাশবোর্ড থেকে মুছে যাবে।')) {
            showLoader(clearHistoryBtn);
             try {
                // Get all links to delete
                const linksSnapshot = await db.collection('users').doc(currentUserUid).collection('links').get();
                const batch = db.batch();
                
                linksSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                    // NOTE: Global links in 'all_short_links' are NOT deleted here, 
                    // allowing existing short links to continue working, but they won't appear on the user's dashboard.
                });

                await batch.commit();
                showAlert("সফল!", "ইতিহাস মুছে ফেলা হয়েছে।", "success");

             } catch (error) {
                console.error("Clear History Error:", error);
                showAlert("ত্রুটি!", "ইতিহাস মুছতে সমস্যা হয়েছে।", "error");
             } finally {
                hideLoader(clearHistoryBtn, 'সব মুছুন');
             }
        }
    });

  </script>
</body>
</html>
